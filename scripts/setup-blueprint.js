#!/usr/bin/env node

const inquirer = require('inquirer');
const fs = require('fs');
const path = require('path');

// ANSI color codes for terminal output
const colors = {
    reset: '\x1b[0m',
    bright: '\x1b[1m',
    green: '\x1b[32m',
    blue: '\x1b[34m',
    yellow: '\x1b[33m',
    red: '\x1b[31m',
    cyan: '\x1b[36m',
};

// Helper function for colored console output
function log(message, color = 'reset') {
    console.log(`${colors[color]}${message}${colors.reset}`);
}

// Check if setup has already been run
function isAlreadySetup() {
    const blueprintPath = path.join(process.cwd(), 'blueprint.json');
    return fs.existsSync(blueprintPath);
}

// Validate email format
function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email) || 'Please enter a valid email address';
}

// Generate brand.ts file
function generateBrandConfig(answers) {
    const content = `// Auto-generated by setup wizard
// Edit this file to customize your brand

export const brand = {
    name: "${answers.projectName}",
    tagline: "${answers.tagline}",

    product: {
        url: process.env.NEXT_PUBLIC_APP_URL || "https://yourapp.com",
    },

    company: {
        legalName: "${answers.projectName} Private Limited",
        gstin: "YOUR_GSTIN_HERE",
        address: {
            street: "123 Business Park",
            city: "Bangalore",
            state: "Karnataka",
            stateCode: "KA",
            pincode: "560001",
            country: "India",
        },
    },

    contact: {
        email: "${answers.email}",
        phone: "+91 XXXXX XXXXX",
        supportUrl: process.env.NEXT_PUBLIC_APP_URL + "/contact" || "https://yourapp.com/contact",
    },

    email: {
        fromSupport: "${answers.email}",
        fromNoReply: "noreply@yourapp.com",
        fromBilling: "billing@yourapp.com",
    },

    social: {
        twitter: "https://twitter.com/yourhandle",
        github: "https://github.com/yourusername",
        linkedin: "https://linkedin.com/company/yourcompany",
    },

    pricing: {
        currency: "INR",
        currencySymbol: "â‚¹",
        plans: {
            starter: {
                name: "Starter",
                priceInPaise: 99900, // â‚¹999
                features: ["Feature 1", "Feature 2", "Feature 3"],
            },
            pro: {
                name: "Pro",
                priceInPaise: 249900, // â‚¹2,499
                features: ["All Starter features", "Feature 4", "Feature 5"],
            },
        },
    },

    seo: {
        title: "${answers.projectName} - ${answers.tagline}",
        description: "${answers.tagline}",
        keywords: ["saas", "nextjs", "india", "boilerplate"],
        ogImage: "/og-image.png",
    },
};
`;

    const filePath = path.join(process.cwd(), 'src', 'config', 'brand.ts');
    const dir = path.dirname(filePath);

    if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true });
    }

    fs.writeFileSync(filePath, content, 'utf8');
    log('âœ“ Created src/config/brand.ts', 'green');
}

// Generate theme.ts file
function generateThemeConfig(answers) {
    const colorSchemeMap = {
        'Blue': 'blue',
        'Purple': 'purple',
        'Green': 'green',
        'Orange': 'orange',
        'Neutral': 'neutral',
    };

    const variantMap = {
        'Modern': 'modern',
        'Minimal': 'minimal',
        'Bold': 'bold',
    };

    const content = `// Auto-generated by setup wizard
// Edit this file to customize your theme

export const themeConfig = {
    colorScheme: '${colorSchemeMap[answers.colorScheme]}' as const,
    variant: '${variantMap[answers.visualStyle]}' as const,

    layout: {
        cardStyle: 'elevated' as const, // 'elevated' | 'flat' | 'bordered'
        buttonStyle: 'rounded' as const, // 'rounded' | 'sharp' | 'pill'
        spacing: 'comfortable' as const, // 'compact' | 'comfortable' | 'spacious'
    },

    typography: {
        fontFamily: 'inter' as const, // 'inter' | 'poppins' | 'roboto'
        scale: 'medium' as const, // 'small' | 'medium' | 'large'
    },
};

export type ThemeConfig = typeof themeConfig;
`;

    const filePath = path.join(process.cwd(), 'src', 'config', 'theme.ts');
    const dir = path.dirname(filePath);

    if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true });
    }

    fs.writeFileSync(filePath, content, 'utf8');
    log('âœ“ Created src/config/theme.ts', 'green');
}

// Update layout.tsx theme import
function updateLayoutThemeImport(answers) {
    const colorSchemeMap = {
        'Blue': 'blue',
        'Purple': 'purple',
        'Green': 'green',
        'Orange': 'orange',
        'Neutral': 'neutral',
    };

    const colorScheme = colorSchemeMap[answers.colorScheme];
    const layoutPath = path.join(process.cwd(), 'src', 'app', 'layout.tsx');

    if (!fs.existsSync(layoutPath)) {
        log('âš  layout.tsx not found, skipping theme import update', 'yellow');
        return;
    }

    let layoutContent = fs.readFileSync(layoutPath, 'utf8');

    // Replace the theme import line
    const themeImportRegex = /import ['"]@\/styles\/themes\/\w+\.css['"];.*$/m;
    const newImport = `import "@/styles/themes/${colorScheme}.css"; // Theme colors (auto-updated by setup wizard)`;

    if (themeImportRegex.test(layoutContent)) {
        layoutContent = layoutContent.replace(themeImportRegex, newImport);
        fs.writeFileSync(layoutPath, layoutContent, 'utf8');
        log('âœ“ Updated layout.tsx theme import', 'green');
    } else {
        log('âš  Could not find theme import in layout.tsx', 'yellow');
    }
}

// Helper: Recursively copy directory
function copyDirectorySync(src, dest, options = {}) {
    const { overwrite = false, skip = [] } = options;
    const copiedFiles = [];
    const skippedFiles = [];

    // Create destination directory if it doesn't exist
    if (!fs.existsSync(dest)) {
        fs.mkdirSync(dest, { recursive: true });
    }

    // Read all items in source directory
    const items = fs.readdirSync(src);

    for (const item of items) {
        const srcPath = path.join(src, item);
        const destPath = path.join(dest, item);

        // Skip .gitkeep files
        if (item === '.gitkeep') continue;

        // Skip files in skip list
        if (skip.includes(item)) {
            skippedFiles.push(item);
            continue;
        }

        const stat = fs.statSync(srcPath);

        if (stat.isDirectory()) {
            // Recursively copy directory
            const result = copyDirectorySync(srcPath, destPath, options);
            copiedFiles.push(...result.copiedFiles);
            skippedFiles.push(...result.skippedFiles);
        } else {
            // Check if file already exists
            if (fs.existsSync(destPath) && !overwrite) {
                skippedFiles.push(destPath.replace(process.cwd(), ''));
                continue;
            }

            // Copy file
            fs.copyFileSync(srcPath, destPath);
            copiedFiles.push(destPath.replace(process.cwd(), ''));
        }
    }

    return { copiedFiles, skippedFiles };
}

// Copy blueprint files
function copyBlueprintFiles(blueprintType, forceOverwrite = false) {
    const blueprintMap = {
        'SaaS Tool': 'saas-tool',
        'Marketplace': 'marketplace',
        'E-commerce': 'ecommerce',
        'Blank': 'blank',
    };

    const blueprintSlug = blueprintMap[blueprintType];
    const blueprintDir = path.join(process.cwd(), 'blueprints', blueprintSlug);

    if (!fs.existsSync(blueprintDir)) {
        log(`âš  Blueprint directory not found: ${blueprintDir}`, 'yellow');
        return;
    }

    // Check if blueprint is empty (like blank)
    const hasContent = fs.readdirSync(blueprintDir).filter(f => f !== '.gitkeep').length > 0;

    if (!hasContent) {
        log(`â„¹ "${blueprintType}" blueprint is minimal - no files to copy`, 'cyan');
        return;
    }

    log(`\nðŸ“¦ Copying "${blueprintType}" blueprint files...`, 'cyan');

    let totalCopied = 0;
    let totalSkipped = 0;

    // 1. Copy app/ files to src/app/ (excluding layout.tsx root)
    const appDir = path.join(blueprintDir, 'app');
    if (fs.existsSync(appDir)) {
        const destAppDir = path.join(process.cwd(), 'src', 'app');
        const result = copyDirectorySync(appDir, destAppDir, {
            overwrite: forceOverwrite,
            skip: ['layout.tsx'], // Don't overwrite root layout
        });

        if (result.copiedFiles.length > 0) {
            log(`  âœ“ Copied ${result.copiedFiles.length} app files`, 'green');
            totalCopied += result.copiedFiles.length;
        }
        if (result.skippedFiles.length > 0 && !forceOverwrite) {
            log(`  âŠ˜ Skipped ${result.skippedFiles.length} existing files`, 'yellow');
            totalSkipped += result.skippedFiles.length;
        }
    }

    // 2. Copy dashboard/ files to src/app/dashboard/
    const dashboardDir = path.join(blueprintDir, 'dashboard');
    if (fs.existsSync(dashboardDir)) {
        const destDashboardDir = path.join(process.cwd(), 'src', 'app', 'dashboard');
        const result = copyDirectorySync(dashboardDir, destDashboardDir, {
            overwrite: forceOverwrite,
        });

        if (result.copiedFiles.length > 0) {
            log(`  âœ“ Copied ${result.copiedFiles.length} dashboard files`, 'green');
            totalCopied += result.copiedFiles.length;
        }
        if (result.skippedFiles.length > 0 && !forceOverwrite) {
            log(`  âŠ˜ Skipped ${result.skippedFiles.length} existing files`, 'yellow');
            totalSkipped += result.skippedFiles.length;
        }
    }

    // 3. Copy components/ to src/components/[blueprint-name]/
    const componentsDir = path.join(blueprintDir, 'components');
    if (fs.existsSync(componentsDir)) {
        const destComponentsDir = path.join(process.cwd(), 'src', 'components', blueprintSlug);
        const result = copyDirectorySync(componentsDir, destComponentsDir, {
            overwrite: forceOverwrite,
        });

        if (result.copiedFiles.length > 0) {
            log(`  âœ“ Copied ${result.copiedFiles.length} component files to src/components/${blueprintSlug}/`, 'green');
            totalCopied += result.copiedFiles.length;
        }
        if (result.skippedFiles.length > 0 && !forceOverwrite) {
            log(`  âŠ˜ Skipped ${result.skippedFiles.length} existing files`, 'yellow');
            totalSkipped += result.skippedFiles.length;
        }
    }

    // 4. Show message about migration.sql
    const migrationFile = path.join(blueprintDir, 'migration.sql');
    if (fs.existsSync(migrationFile)) {
        console.log('');
        log('ðŸ“„ Database Migration Required:', 'yellow');
        log(`   Run the SQL in: blueprints/${blueprintSlug}/migration.sql`, 'yellow');
        log('   Execute in Supabase SQL Editor', 'yellow');
    }

    // Summary
    if (totalSkipped > 0 && !forceOverwrite) {
        console.log('');
        log(`â„¹ To overwrite existing files, run: node scripts/setup-blueprint.js --force`, 'cyan');
    }

    console.log('');
}

// Create blueprint.json
function createBlueprintJson(answers) {
    const blueprintMap = {
        'SaaS Tool': 'saas-tool',
        'Marketplace': 'marketplace',
        'E-commerce': 'ecommerce',
        'Blank': 'blank',
    };

    const content = {
        type: blueprintMap[answers.blueprint],
        name: answers.projectName,
        createdAt: new Date().toISOString(),
        colorScheme: answers.colorScheme.toLowerCase(),
        visualStyle: answers.visualStyle.toLowerCase(),
    };

    const filePath = path.join(process.cwd(), 'blueprint.json');
    fs.writeFileSync(filePath, JSON.stringify(content, null, 2), 'utf8');
    log('âœ“ Created blueprint.json', 'green');
}

// Update PROJECT_CONTEXT.md
function updateProjectContext(answers) {
    const blueprintMap = {
        'SaaS Tool': 'saas-tool',
        'Marketplace': 'marketplace',
        'E-commerce': 'ecommerce',
        'Blank': 'blank',
    };

    const content = `# PROJECT CONTEXT

Auto-generated by PropelKit setup wizard on ${new Date().toLocaleDateString()}

## Project Information

- **Name**: ${answers.projectName}
- **Tagline**: ${answers.tagline}
- **Blueprint**: ${blueprintMap[answers.blueprint]}
- **Color Scheme**: ${answers.colorScheme}
- **Visual Style**: ${answers.visualStyle}
- **Support Email**: ${answers.email}

## What is this project?

${answers.projectName} is built using the PropelKit SaaS boilerplate for Indian developers.

## Tech Stack

- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript (strict mode)
- **Database**: Supabase (PostgreSQL + Auth + RLS)
- **Payments**: Razorpay (one-time + subscriptions)
- **Email**: Resend (transactional emails)
- **Jobs**: Inngest (background tasks)
- **UI**: shadcn/ui + Tailwind CSS
- **Validation**: Zod

## Important Files

- \`src/config/brand.ts\` - Brand configuration (SINGLE SOURCE OF TRUTH)
- \`src/config/theme.ts\` - Visual theme configuration
- \`blueprint.json\` - Selected blueprint information
- \`.env.local\` - Environment variables (create this!)

## Next Steps

1. Copy \`.env.example\` to \`.env.local\` and fill in your values
2. Set up Supabase project and add credentials
3. Set up Razorpay account and add API keys
4. Run database migrations
5. Start development: \`npm run dev\`

## Dynamic Branding

This project uses dynamic brand configuration. Never hardcode:
- âŒ \`const name = "PropelKit"\`
- âœ… \`const name = brand.name\`

Always import: \`import { brand } from '@/config/brand'\`

## Support

For help with PropelKit, visit: https://propelkit.dev/docs
`;

    const dir = path.join(process.cwd(), '.claude');
    const filePath = path.join(dir, 'PROJECT_CONTEXT.md');

    if (!fs.existsSync(dir)) {
        fs.mkdirSync(dir, { recursive: true });
    }

    fs.writeFileSync(filePath, content, 'utf8');
    log('âœ“ Created .claude/PROJECT_CONTEXT.md', 'green');
}

// Display welcome banner
function showWelcome() {
    console.log('');
    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'cyan');
    log('         ðŸš€ PropelKit Setup Wizard ðŸš€', 'bright');
    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'cyan');
    console.log('');
    log('Welcome! This wizard will help you configure your SaaS project.', 'blue');
    console.log('');
}

// Display success message
function showSuccess(answers) {
    console.log('');
    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'green');
    log('            âœ¨ Setup Complete! âœ¨', 'bright');
    log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'green');
    console.log('');
    log(`Your project "${answers.projectName}" is ready!`, 'green');
    console.log('');
    log('Next steps:', 'bright');
    log('1. Copy .env.example to .env.local and add your credentials', 'blue');
    log('2. Set up Supabase: https://supabase.com', 'blue');
    log('3. Set up Razorpay: https://razorpay.com', 'blue');
    log('4. Run database migrations', 'blue');
    log('5. Start dev server: npm run dev', 'blue');
    console.log('');
    log('Documentation: https://propelkit.dev/docs', 'cyan');
    log('Need help? support@propelkit.dev', 'cyan');
    console.log('');
}

// Main setup function
async function setup(options = {}) {
    const { forceOverwrite = false } = options;

    // Check if already setup
    if (isAlreadySetup()) {
        // Be silent during postinstall to avoid annoying developers
        const isPostinstall = process.env.npm_lifecycle_event === 'postinstall';

        if (!isPostinstall) {
            log('âš  Setup already completed!', 'yellow');
            log('blueprint.json already exists.', 'yellow');
            console.log('');
            log('To re-run setup:', 'cyan');
            log('1. Delete blueprint.json', 'cyan');
            log('2. Run: npm run setup', 'cyan');
            console.log('');
        }
        process.exit(0);
    }

    // Check if running in non-interactive environment (CI/CD)
    if (!process.stdin.isTTY && process.env.npm_lifecycle_event === 'postinstall') {
        // Silent exit in CI/CD during postinstall
        process.exit(0);
    }

    showWelcome();

    if (forceOverwrite) {
        log('âš  Running in FORCE mode - will overwrite existing files\n', 'yellow');
    }

    try {
        // Ask setup questions
        const answers = await inquirer.prompt([
            {
                type: 'list',
                name: 'blueprint',
                message: 'What are you building?',
                choices: [
                    {
                        name: 'SaaS Tool - Dashboard/analytics app',
                        value: 'SaaS Tool',
                    },
                    {
                        name: 'Marketplace - Two-sided platform',
                        value: 'Marketplace',
                    },
                    {
                        name: 'E-commerce - Online store',
                        value: 'E-commerce',
                    },
                    {
                        name: 'Blank - Minimal starter (build from scratch)',
                        value: 'Blank',
                    },
                ],
            },
            {
                type: 'input',
                name: 'projectName',
                message: 'Project name:',
                validate: (input) => {
                    if (input.trim().length < 2) {
                        return 'Project name must be at least 2 characters';
                    }
                    return true;
                },
            },
            {
                type: 'input',
                name: 'tagline',
                message: 'Tagline (short description):',
                validate: (input) => {
                    if (input.trim().length < 5) {
                        return 'Tagline must be at least 5 characters';
                    }
                    return true;
                },
            },
            {
                type: 'list',
                name: 'colorScheme',
                message: 'Choose a color scheme:',
                choices: ['Blue', 'Purple', 'Green', 'Orange', 'Neutral'],
                default: 'Blue',
            },
            {
                type: 'list',
                name: 'visualStyle',
                message: 'Choose a visual style:',
                choices: ['Modern', 'Minimal', 'Bold'],
                default: 'Modern',
            },
            {
                type: 'input',
                name: 'email',
                message: 'Support email:',
                validate: validateEmail,
            },
        ]);

        console.log('');
        log('âš™ï¸  Setting up your project...', 'cyan');
        console.log('');

        // Generate configuration files
        generateBrandConfig(answers);
        generateThemeConfig(answers);
        updateLayoutThemeImport(answers);

        // Copy blueprint files
        copyBlueprintFiles(answers.blueprint, forceOverwrite);

        // Create blueprint.json
        createBlueprintJson(answers);

        // Update PROJECT_CONTEXT.md
        updateProjectContext(answers);

        // Show success message
        showSuccess(answers);

    } catch (error) {
        if (error.isTtyError) {
            log('âœ— Prompt couldn\'t be rendered in this environment', 'red');
        } else if (error.name === 'ExitPromptError') {
            log('\nâœ— Setup cancelled by user', 'yellow');
            process.exit(0);
        } else {
            log(`âœ— Error during setup: ${error.message}`, 'red');
            console.error(error);
            process.exit(1);
        }
    }
}

// Run setup if executed directly
if (require.main === module) {
    // Parse command-line arguments
    const args = process.argv.slice(2);
    const forceOverwrite = args.includes('--force') || args.includes('-f');

    setup({ forceOverwrite }).catch((error) => {
        console.error(error);
        process.exit(1);
    });
}

module.exports = { setup };
